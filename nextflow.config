params {
    // Input Folders and Files
    outdir          = "./output"
    samples         = null
    ref             = null
    past_calls      = false

    // Target/Regions Configuration
    probes          = "null"
    multiqc_config  = "multiqc_config.yaml"
    
    // Chunking Configuration
    // If a chromosome is smaller than this, it won't be split.
    chunk_size      = 10000 
}

// Executor configuration for high-throughput sample processing
executor {
    name            = 'slurm'
    queueSize       = 300
    submitRateLimit = '10 sec'
}

process {
    executor       = 'slurm'
    clusterOptions = '--account=munoz --qos=munoz'
    beforeScript   = 'module purge'

    // Error handling: retry on common HPC transient errors (memory/preemption)
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 2

    // 1. TRIMMING
    withName: TRIM {
        module = 'trimmomatic/0.39'
        cpus   = 1
        memory = { 2.GB * task.attempt }
        time   = '1h'
    }

    // 2. ALIGNMENT
    withName: ALIGN {
        module = 'bwa/0.7.17:samtools/1.20'
        cpus   = 2
        memory = { 5.GB * task.attempt }
        time   = '12h'
    }

    // 3. INDIVIDUAL PILEUP (Nome corrigido para INDIVIDUAL_PILEUP)
    withName: INDIVIDUAL_PILEUP {
        module = 'bcftools/1.22:samtools/1.20'
        cpus   = 2
        memory = { params.probes ? 10.GB * task.attempt : 8.GB * task.attempt }
        time   = { params.probes ? '20h' : '4h' }
    }

    // 4. SPLIT VCF TO CHUNK (Nome corrigido para SPLIT_VCF_TO_CHUNK)
    withName: SPLIT_VCF_TO_CHUNK {
        module = 'bcftools/1.22'
        cpus   = 1
        memory = '2 GB'
        time   = '30m'
    }

    // 5. JOINT CALLING BY CHUNK (Nome corrigido para MERGE_AND_CALL_BY_CHUNK)
    withName: MERGE_AND_CALL_BY_CHUNK {
        module = 'bcftools/1.22'
        cpus   = 1
        memory = { 4.GB * task.attempt }
        time   = '2h'
    }

    // 6. FINAL CONCATENATION (Nome corrigido para CONCATENATE_ALL)
    withName: CONCATENATE_ALL {
        module = 'bcftools/1.22'
        cpus   = 2
        memory = '20 GB'
        time   = '5h'
    }

    // 7. QUALITY CONTROL
    withName: QC_BAM {
        module = 'samtools/1.20'
        cpus   = 2
        memory = '4 GB'
        time   = '4h'
    }

    withName: COVERAGE_QC {
        module = 'mosdepth/0.3.1'
        cpus   = 2
        memory = '4 GB'
        time   = '4h'
    }

    // 8. FINAL REPORT
    withName: MULTIQC {
        module = 'multiqc/1.28'
        cpus   = 1
        memory = '4 GB'
        time   = '1h'
    }
}

// Execution Metadata and Monitoring
trace {
    enabled = true
    file    = "${params.outdir}/pipeline_trace.txt"
    fields  = 'task_id,name,status,exit,realtime,%cpu,rss,vmem'
}

report {
    enabled = true
    file    = "${params.outdir}/execution_report.html"
}

// Automatically delete intermediate 'work' files upon successful completion
cleanup = true
