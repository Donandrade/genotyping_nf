params {
    // Input Folders and Files
    outdir          = "./output"
    samples         = null
    ref             = null
    past_calls      = false

    // Target/Regions Configuration
    probes          = "null"
    multiqc_config  = "multiqc_config.yaml"

    // Chunking Configuration - REMOVIDO pois agora usamos cromossomos inteiros
}

executor {
    name            = 'slurm'
    queueSize       = 300
    submitRateLimit = '10 sec'
}

process {
    executor       = 'slurm'
    clusterOptions = '--account=munoz --qos=munoz'
    beforeScript   = 'module purge'

    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 2

    // 1. TRIMMING
    withName: TRIM {
        module = 'trimmomatic/0.39'
        cpus   = 1
        memory = { 2.GB * task.attempt }
        time   = '1h'
    }

    // 2. ALIGNMENT
    withName: ALIGN {
        module = 'bwa/0.7.17:samtools/1.20'
        cpus   = 2
        memory = { 10.GB * task.attempt }
        time   = '12h'
    }

    // 3. INDIVIDUAL PILEUP
    withName: INDIVIDUAL_PILEUP {
        module = 'bcftools/1.22:samtools/1.20'
        cpus   = 2
        memory = { (params.probes && params.probes != "null") ? 12.GB * task.attempt : 8.GB * task.attempt }
        time   = { (params.probes && params.probes != "null") ? '20h' : '6h' }
    }

    // 5. JOINT CALLING BY CHROMOSOME
    // Aumentamos a mem√≥ria e o tempo, pois processar um cromossomo inteiro exige mais do bcftools merge/call
    withName: MERGE_AND_CALL_BY_CHROM {
        module = 'bcftools/1.22'
        cpus   = 4 // Aumentado para melhor performance no merge de muitos arquivos
        memory = { 32.GB * task.attempt } // Base de 32GB, sobe para 64GB em caso de retry
        time   = { 12.h * task.attempt }   // Aumentado para 12h para garantir cromossomos grandes
    }

    // 6. FINAL CONCATENATION
    withName: CONCATENATE_ALL {
        module = 'bcftools/1.22'
        cpus   = 2
        memory = '100 GB' 
        time   = '5h'
    }

    // Processos de QC (Mantidos conforme sua necessidade)
    withName: 'QC_BAM|COVERAGE_QC' {
        cpus   = 2
        memory = '4 GB'
        time   = '4h'
    }

    withName: MULTIQC {
        module = 'multiqc/1.28'
        cpus   = 1
        memory = '4 GB'
        time   = '1h'
    }
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_trace.txt"
    fields  = 'task_id,name,status,exit,realtime,%cpu,rss,vmem'
}

report {
    enabled = true
    file    = "${params.outdir}/execution_report.html"
}

cleanup = false
